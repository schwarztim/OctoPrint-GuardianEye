<div id="settings_plugin_guardianeye">
    <!-- General -->
    <div class="guardianeye-settings-section">
        <h4>General</h4>
        <div class="control-group">
            <label class="checkbox">
                <input type="checkbox" data-bind="checked: settings.settings.plugins.guardianeye.enabled" />
                Enable GuardianEye
            </label>
        </div>
        <div class="control-group">
            <label class="checkbox">
                <input type="checkbox" data-bind="checked: settings.settings.plugins.guardianeye.auto_start" />
                Auto-start monitoring when print begins
            </label>
        </div>
    </div>

    <!-- AI Provider -->
    <div class="guardianeye-settings-section">
        <h4>AI Vision Provider</h4>

        <!-- Provider Selection -->
        <div class="control-group">
            <label class="control-label">Provider</label>
            <div class="controls">
                <select data-bind="value: settings.settings.plugins.guardianeye.provider" class="input-block-level">
                    <option value="openai">OpenAI</option>
                    <option value="azure_openai">Azure OpenAI</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                    <option value="xai">xAI / Grok</option>
                    <option value="gemini">Google Gemini</option>
                    <option value="ollama">Ollama (Local / Free)</option>
                </select>
            </div>
        </div>

        <!-- Endpoint (all providers) -->
        <div class="control-group">
            <label class="control-label">Endpoint</label>
            <div class="controls">
                <input type="text" class="input-block-level"
                       data-bind="value: settings.settings.plugins.guardianeye.endpoint,
                                  attr: { placeholder: endpointPlaceholder }" />
                <span class="help-block">Leave empty to use the default endpoint for the selected provider</span>
            </div>
        </div>

        <!-- API Key (hidden for Ollama) -->
        <div class="control-group" data-bind="visible: settings.settings.plugins.guardianeye.provider() !== 'ollama'">
            <label class="control-label">API Key</label>
            <div class="controls">
                <input type="password" class="input-block-level"
                       data-bind="value: settings.settings.plugins.guardianeye.api_key"
                       placeholder="Enter API key..." />
            </div>
        </div>

        <!-- Model (all providers) -->
        <div class="control-group">
            <label class="control-label">Model</label>
            <div class="controls">
                <input type="text" class="input-block-level"
                       data-bind="value: settings.settings.plugins.guardianeye.model,
                                  attr: { placeholder: modelPlaceholder }" />
                <span class="help-block" data-bind="text: modelHelpText"></span>
            </div>
        </div>

        <!-- Azure-specific: Deployment Name -->
        <div class="control-group" data-bind="visible: settings.settings.plugins.guardianeye.provider() === 'azure_openai'">
            <label class="control-label">Deployment Name</label>
            <div class="controls">
                <input type="text" class="input-block-level"
                       data-bind="value: settings.settings.plugins.guardianeye.azure_deployment"
                       placeholder="gpt-4o-mini" />
                <span class="help-block">Azure deployment name (may differ from model name)</span>
            </div>
        </div>

        <!-- Azure-specific: API Version -->
        <div class="control-group" data-bind="visible: settings.settings.plugins.guardianeye.provider() === 'azure_openai'">
            <label class="control-label">API Version</label>
            <div class="controls">
                <input type="text" class="input-block-level"
                       data-bind="value: settings.settings.plugins.guardianeye.azure_api_version"
                       placeholder="2025-01-01-preview" />
            </div>
        </div>

        <!-- Ollama hint -->
        <div data-bind="visible: settings.settings.plugins.guardianeye.provider() === 'ollama'"
             style="padding: 6px 10px; background: #f0f8ff; border-radius: 4px; font-size: 12px; margin-bottom: 10px;">
            <strong>Tip:</strong> Ensure the model is pulled: <code>ollama pull llava</code>
        </div>

        <!-- Test Connection -->
        <div class="control-group">
            <div class="controls">
                <button class="btn" data-bind="click: testConnection, disable: testRunning">
                    <i class="fa fa-plug"></i>
                    <span data-bind="visible: !testRunning()">Test Connection</span>
                    <span data-bind="visible: testRunning">Testing...</span>
                </button>
                <div class="guardianeye-test-result"
                     data-bind="visible: testResult(), css: testSuccess() ? 'guardianeye-test-success' : 'guardianeye-test-failure'">
                    <span data-bind="text: testResult"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Monitoring -->
    <div class="guardianeye-settings-section">
        <h4>Monitoring</h4>
        <div class="control-group">
            <label class="control-label">Check Interval (seconds)</label>
            <div class="controls">
                <input type="number" min="10" max="600"
                       data-bind="value: settings.settings.plugins.guardianeye.interval_seconds" />
                <span class="help-block">How often to capture and analyze a snapshot (min 10s)</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">Min Layer for Vision</label>
            <div class="controls">
                <input type="number" min="0" max="20"
                       data-bind="value: settings.settings.plugins.guardianeye.min_layer_for_vision" />
                <span class="help-block">Skip AI analysis before this layer (first layers are too sparse)</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">Failure Strikes</label>
            <div class="controls">
                <input type="number" min="1" max="10"
                       data-bind="value: settings.settings.plugins.guardianeye.fail_strikes" />
                <span class="help-block">Consecutive FAIL verdicts needed to stop the print</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">Layer Height (mm)</label>
            <div class="controls">
                <input type="number" step="0.01" min="0.04" max="1.0"
                       data-bind="value: settings.settings.plugins.guardianeye.layer_height" />
                <span class="help-block">Used to estimate layer number from Z height</span>
            </div>
        </div>
    </div>

    <!-- Snapshot -->
    <div class="guardianeye-settings-section">
        <h4>Snapshot</h4>
        <div class="control-group">
            <label class="control-label">Snapshot URL Override</label>
            <div class="controls">
                <input type="text" class="input-block-level"
                       data-bind="value: settings.settings.plugins.guardianeye.snapshot_url"
                       placeholder="Leave empty to auto-detect from OctoPrint settings" />
            </div>
        </div>
        <div class="control-group">
            <label class="checkbox">
                <input type="checkbox" data-bind="checked: settings.settings.plugins.guardianeye.delete_after_analysis" />
                Delete snapshots after analysis (saves disk space)
            </label>
        </div>
        <div class="control-group" data-bind="visible: !settings.settings.plugins.guardianeye.delete_after_analysis()">
            <label class="control-label">Snapshot Retention</label>
            <div class="controls">
                <input type="number" min="1" max="1000"
                       data-bind="value: settings.settings.plugins.guardianeye.snapshot_retention" />
                <span class="help-block">Max snapshots to keep on disk</span>
            </div>
        </div>
    </div>

    <!-- Custom Prompt -->
    <div class="guardianeye-settings-section">
        <h4>Custom Prompt</h4>
        <div class="control-group">
            <div class="controls">
                <textarea class="guardianeye-prompt-textarea"
                          data-bind="value: settings.settings.plugins.guardianeye.custom_prompt"
                          placeholder="Leave empty to use the default prompt. Use {stage_context} placeholder for stage-specific instructions."></textarea>
                <span class="help-block">Override the AI vision prompt. Leave empty for the battle-tested default.</span>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div class="guardianeye-settings-section">
        <h4>Notifications</h4>
        <div class="control-group">
            <label class="checkbox">
                <input type="checkbox" data-bind="checked: settings.settings.plugins.guardianeye.notifications.octoprint_popup" />
                OctoPrint popup notification
            </label>
        </div>

        <!-- Webhook -->
        <div class="control-group">
            <label class="checkbox">
                <input type="checkbox" data-bind="checked: settings.settings.plugins.guardianeye.notifications.webhook_enabled" />
                Webhook (Home Assistant, IFTTT, etc.)
            </label>
        </div>
        <div data-bind="visible: settings.settings.plugins.guardianeye.notifications.webhook_enabled">
            <div class="control-group">
                <label class="control-label">Webhook URL</label>
                <div class="controls">
                    <input type="text" class="input-block-level"
                           data-bind="value: settings.settings.plugins.guardianeye.notifications.webhook_url"
                           placeholder="https://..." />
                </div>
            </div>
        </div>

        <!-- Discord -->
        <div class="control-group">
            <label class="checkbox">
                <input type="checkbox" data-bind="checked: settings.settings.plugins.guardianeye.notifications.discord_enabled" />
                Discord
            </label>
        </div>
        <div data-bind="visible: settings.settings.plugins.guardianeye.notifications.discord_enabled">
            <div class="control-group">
                <label class="control-label">Discord Webhook URL</label>
                <div class="controls">
                    <input type="text" class="input-block-level"
                           data-bind="value: settings.settings.plugins.guardianeye.notifications.discord_webhook_url"
                           placeholder="https://discord.com/api/webhooks/..." />
                </div>
            </div>
        </div>

        <!-- Telegram -->
        <div class="control-group">
            <label class="checkbox">
                <input type="checkbox" data-bind="checked: settings.settings.plugins.guardianeye.notifications.telegram_enabled" />
                Telegram
            </label>
        </div>
        <div data-bind="visible: settings.settings.plugins.guardianeye.notifications.telegram_enabled">
            <div class="control-group">
                <label class="control-label">Bot Token</label>
                <div class="controls">
                    <input type="password" class="input-block-level"
                           data-bind="value: settings.settings.plugins.guardianeye.notifications.telegram_bot_token"
                           placeholder="123456:ABC-..." />
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">Chat ID</label>
                <div class="controls">
                    <input type="text" class="input-block-level"
                           data-bind="value: settings.settings.plugins.guardianeye.notifications.telegram_chat_id"
                           placeholder="12345678" />
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced -->
    <div class="guardianeye-settings-section">
        <h4>Advanced</h4>
        <div class="control-group">
            <label class="checkbox">
                <input type="checkbox" data-bind="checked: settings.settings.plugins.guardianeye.cost_tracking" />
                Track API costs
            </label>
        </div>
    </div>
</div>
